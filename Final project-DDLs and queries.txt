---ORACLE DDL- Schema.sql

CREATE TABLE LIB_BRANCH(
BRANCH_ID          NUMBER PRIMARY KEY,
BRANCH_NAME        VARCHAR2(500),
BRANCH_LOCATION    VARCHAR2(2500)
);

CREATE TABLE MEMBER (
    MEMBER_ID        NUMBER PRIMARY KEY,
    NAME             VARCHAR2(100) NOT NULL,
    EMAIL            VARCHAR2(120) UNIQUE NOT NULL,
    PHONE            VARCHAR2(20),
    JOIN_DATE        DATE DEFAULT SYSDATE,
    MEMBERSHIP_TYPE  VARCHAR2(10)
);

ALTER TABLE MEMBER
ADD MEM_FEE NUMBER;


CREATE TABLE BOOK (
    BOOK_ID          NUMBER PRIMARY KEY,
    TITLE            VARCHAR2(200) NOT NULL,
    AUTHOR_ID        NUMBER,
    PUBLISHER        VARCHAR2(100),
    PUBLISH_YEAR     NUMBER(4),
    ISBN             VARCHAR2(20) UNIQUE NOT NULL,
    CATEGORY         VARCHAR2(50),
    BRANCH_ID        NUMBER 
);

CREATE TABLE AUTHOR (
    AUTHOR_ID        NUMBER PRIMARY KEY,
    NAME             VARCHAR2(100) NOT NULL,
    BIRTH_YEAR       NUMBER(4),
    COUNTRY          VARCHAR2(50)
);

CREATE TABLE BOOK_AUTHOR (
    BOOK_ID          NUMBER NOT NULL,
    AUTHOR_ID        NUMBER NOT NULL,
    PRIMARY KEY (BOOK_ID, AUTHOR_ID),
    FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID),
    FOREIGN KEY (AUTHOR_ID) REFERENCES AUTHOR(AUTHOR_ID)
);

CREATE TABLE BORROW (
    BORROW_ID          NUMBER PRIMARY KEY,
    MEMBER_ID        NUMBER NOT NULL,
    BOOK_ID          NUMBER NOT NULL,
    BORROW_DATE      DATE DEFAULT SYSDATE,
    DUE_DATE         DATE NOT NULL,
    RETURN_DATE      DATE,
    BRANCH_ID        NUMBER
    FOREIGN KEY (MEMBER_ID) REFERENCES MEMBER(MEMBER_ID),
    FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID)
);

CREATE TABLE STAFF(
NAME       VARCHAR2(100),
ROLE       VARCHAR2(100),
BRANCH_ID  NUMBER
);

CREATE TABLE BRANCH_TRANSFER(
FROM_BRANCH_ID  NUMBER,
TO_BRANCH_ID    NUMBER,
BOOK_ID         NUMBER,
TRANSFER_DATE   DATE
);

CREATE TABLE CHECK_OUT( 
    BOOK_ID NUMBER NOT NULL,
    CHECK-IN_DATE DATE
    BRANCH_ID NUMBER
);

CREATE TABLE HOLD_REQ(
BOOK_ID       NUMBER,
MEMBER_ID     NUMBER,
REQUEST_DATE  DATE NOT NULL,
STATUS        VARCHAR2(20),
FOREIGN KEY (MEMBER_ID) REFERENCES MEMBER(MEMBER_ID),
FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID)
);

-----Data Science tables:-

---------------------------------------------------------
-- ORACLE SCHEMA FOR LIBRARY + DATA SCIENCE EXTENSIONS
---------------------------------------------------------

-- Drop before create safety (optional)
-- Use reset.sql instead to fully clean.

---------------------------------------------------------
-- CORE TABLES
---------------------------------------------------------

CREATE TABLE MEMBER (
    MEMBER_ID        NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME             VARCHAR2(100) NOT NULL,
    EMAIL            VARCHAR2(120) UNIQUE NOT NULL,
    PHONE            VARCHAR2(20),
    JOIN_DATE        DATE DEFAULT SYSDATE
);

CREATE TABLE BOOK (
    BOOK_ID          NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ISBN             VARCHAR2(20) UNIQUE NOT NULL,
    TITLE            VARCHAR2(200) NOT NULL,
    GENRE            VARCHAR2(50),
    PUBLISH_YEAR     NUMBER(4),
    PUBLISHER        VARCHAR2(100)
);

CREATE TABLE AUTHOR (
    AUTHOR_ID        NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME             VARCHAR2(100) NOT NULL,
    BIRTH_YEAR       NUMBER(4),
    COUNTRY          VARCHAR2(50)
);

CREATE TABLE BOOK_AUTHOR (
    BOOK_ID          NUMBER NOT NULL,
    AUTHOR_ID        NUMBER NOT NULL,
    PRIMARY KEY (BOOK_ID, AUTHOR_ID),
    FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID),
    FOREIGN KEY (AUTHOR_ID) REFERENCES AUTHOR(AUTHOR_ID)
);

CREATE TABLE LOAN (
    LOAN_ID          NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MEMBER_ID        NUMBER NOT NULL,
    BOOK_ID          NUMBER NOT NULL,
    LOAN_DATE        DATE DEFAULT SYSDATE,
    DUE_DATE         DATE NOT NULL,
    RETURN_DATE      DATE,
    FOREIGN KEY (MEMBER_ID) REFERENCES MEMBER(MEMBER_ID),
    FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID)
);

---------------------------------------------------------
-- DATA SCIENCE EXTENSION TABLES (10 tables)
---------------------------------------------------------

CREATE TABLE EVENT_LOG (
    EVENT_ID         NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MEMBER_ID        NUMBER,
    EVENT_TYPE       VARCHAR2(50),
    EVENT_TIMESTAMP  TIMESTAMP DEFAULT SYSTIMESTAMP,
    METADATA         CLOB,
    FOREIGN KEY (MEMBER_ID) REFERENCES MEMBER(MEMBER_ID)
);

CREATE TABLE FEATURE_MEMBER (
    MEMBER_ID            NUMBER PRIMARY KEY,
    TOTAL_LOANS          NUMBER,
    AVG_LOAN_DURATION    NUMBER,
    OVERDUE_RATE         NUMBER,
    FOREIGN KEY (MEMBER_ID) REFERENCES MEMBER(MEMBER_ID)
);

CREATE TABLE FEATURE_BOOK (
    BOOK_ID              NUMBER PRIMARY KEY,
    TOTAL_CHECKOUTS      NUMBER,
    AVG_CHECKOUT_INTERVAL NUMBER,
    POPULARITY_SCORE     NUMBER,
    FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID)
);

CREATE TABLE DAILY_SNAPSHOT_BOOK (
    SNAPSHOT_DATE        DATE,
    BOOK_ID              NUMBER,
    COPIES_CHECKED_OUT   NUMBER,
    ROLLING_7D_CHECKOUTS NUMBER,
    PRIMARY KEY (SNAPSHOT_DATE, BOOK_ID),
    FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID)
);

CREATE TABLE DAILY_SNAPSHOT_MEMBER (
    SNAPSHOT_DATE        DATE,
    MEMBER_ID            NUMBER,
    TOTAL_ACTIVE_LOANS   NUMBER,
    ROLLING_30D_VISITS   NUMBER,
    PRIMARY KEY (SNAPSHOT_DATE, MEMBER_ID),
    FOREIGN KEY (MEMBER_ID) REFERENCES MEMBER(MEMBER_ID)
);

CREATE TABLE BOOK_RATING (
    RATING_ID            NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MEMBER_ID            NUMBER NOT NULL,
    BOOK_ID              NUMBER NOT NULL,
    RATING               NUMBER CHECK (RATING BETWEEN 1 AND 5),
    RATING_DATE          DATE DEFAULT SYSDATE,
    FOREIGN KEY (MEMBER_ID) REFERENCES MEMBER(MEMBER_ID),
    FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID)
);

CREATE TABLE BOOK_TAG (
    TAG_ID               NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TAG_NAME             VARCHAR2(50) UNIQUE NOT NULL
);

CREATE TABLE BOOK_TAG_MAP (
    BOOK_ID              NUMBER NOT NULL,
    TAG_ID               NUMBER NOT NULL,
    PRIMARY KEY (BOOK_ID, TAG_ID),
    FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID),
    FOREIGN KEY (TAG_ID) REFERENCES BOOK_TAG(TAG_ID)
);

CREATE TABLE BOOK_RECOMMENDATION (
    REC_ID               NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MEMBER_ID            NUMBER,
    BOOK_ID              NUMBER,
    SCORE                NUMBER,
    GENERATED_DATE       DATE DEFAULT SYSDATE,
    FOREIGN KEY (MEMBER_ID) REFERENCES MEMBER(MEMBER_ID),
    FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID)
);

CREATE TABLE SUMMARY_BOOK_STATS (
    BOOK_ID              NUMBER PRIMARY KEY,
    MEAN_RATING          NUMBER,
    MEDIAN_RATING        NUMBER,
    STDDEV_RATING        NUMBER,
    TOTAL_RATINGS        NUMBER,
    FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID)
);


---INSERT Statements(Sample data) DMLs--sample_data.sql :

INSERT INTO LIB_BRANCH(BRANCH_ID, BRANCH_NAME, BRANCH_LOCATION)VALUES
(1, 'Mahatma Gandhi Gardens', 'Central Ave, Jersey City, NJ-07307'),
(2, 'Five Corners', 'JFK Blvd, Jersey City, NJ-07306'),
(3, 'Best Reference', '20 Main Street, 8th Ave, NY-10001');

INSERT INTO MEMBER (MEMBER_ID,NAME, EMAIL, PHONE, JOIN_DATE, MEMBERSHIP_TYPE) VALUES
('235','Alice Johnson', 'alice@example.com', '123-456'),
('0001','Bob Smith', 'bob@example.com', '202-202'),
('764','Carla Green', 'carla@example.com', '303-303');

INSERT INTO AUTHOR (NAME, BIRTH_YEAR, COUNTRY) VALUES
('George Orwell', 1903, 'UK'),
('J.K. Rowling', 1965, 'UK'),
('Isaac Asimov', 1920, 'USA');

INSERT INTO BOOK (BOOK_ID,ISBN, TITLE, CATEGORY, PUBLISH_YEAR, PUBLISHER) VALUES
('111','9780451524935', '1984', 'Dystopian', 1949, 'Secker & Warburg'),
('1234','9780439358071', 'Harry Potter and the Order of the Phoenix', 'Fantasy', 2003, 'Bloomsbury'),
('4367','9780553293357', 'Foundation', 'Sci-Fi', 1951, 'Gnome Press');

INSERT INTO BOOK_AUTHOR VALUES (1, 1);
INSERT INTO BOOK_AUTHOR VALUES (2, 2);
INSERT INTO BOOK_AUTHOR VALUES (3, 3);

INSERT INTO STAFF VALUES( 'Michelle', 'Librarian',101);
INSERT INTO STAFF VALUES( 'Lucas', 'Library Coordinator',412);
INSERT INTO STAFF VALUES( 'Jessie', 'Intern', 1000);

INSERT INTO BOOK_RATING (MEMBER_ID, BOOK_ID, RATING) VALUES(1000, 1, 5);
INSERT INTO BOOK_RATING (MEMBER_ID, BOOK_ID, RATING) VALUES(2000, 1, 4);
INSERT INTO BOOK_RATING (MEMBER_ID, BOOK_ID, RATING) VALUES(7016, 3, 5);

INSERT INTO BOOK_TAG (TAG_NAME) VALUES ('Classic');
INSERT INTO BOOK_TAG (TAG_NAME) VALUES ('Fantasy');
INSERT INTO BOOK_TAG (TAG_NAME) VALUES ('Sci-Fi');

INSERT INTO BOOK_TAG_MAP VALUES (1,1);
INSERT INTO BOOK_TAG_MAP VALUES (2,2);
INSERT INTO BOOK_TAG_MAP VALUES (3,3);

COMMIT;

INSERT INTO BRANCH_TRANSFER VALUES
('1', '2', '111', '4-NOV-2024'),
('2', '3', '3467', '16-DEC-2025'),
('3', '1', '1234', '17-JUL-2018');

INSERT INTO CHECK_OUT VALUES
('111', '5-NOV-2024', '2'),
('1234', '21-AUG-2019', '3');

INSERT INTO HOLD_REQ VALUES
('111', '235','9-JAN-2024', 'Hold'),
('3467','00001', '22-MAR-2019', 'Pending');

-----------Reset scripts- reset.sql

BEGIN
 
--Data Science tables:
    EXECUTE IMMEDIATE 'DROP TABLE BOOK_RATING CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE EVENT_LOG CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE DAILY_SNAPSHOT_BOOK CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE DAILY_SNAPSHOT_MEMBER CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE SUMMARY_BOOK_STATS CASCADE CONSTRAINTS';

---Core tables:
    EXECUTE IMMEDIATE 'DROP TABLE BOOK_AUTHOR CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE HOLD_REQ CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE CHECK_OUT CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE BRANCH_TRANSFER CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE STAFF CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE BORROW CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE BOOK CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE AUTHOR CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE MEMBER CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE LIB_BRANCH CASCADE CONSTRAINTS';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/

        
